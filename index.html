<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة مزرعة الأرانب</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            font-weight: bold;
            border-radius: 10px 10px 0 0;
        }
        .icon-box {
            font-size: 2.5rem;
            color: #0d6efd;
            margin-bottom: 15px;
            text-align: center;
        }
        .table td, .table th {
            vertical-align: middle;
        }
        .section-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .rabbit-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
        }
        .form-label {
            font-weight: bold;
        }
        .btn {
            border-radius: 5px;
        }
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1 class="mb-2">نظام إدارة مزرعة الأرانب</h1>
            <p class="lead">النظام المتكامل لإدارة مزارع الأرانب</p>
        </div>

        <div id="home-page">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="icon-box">
                                <i class="bi bi-database"></i>
                            </div>
                            <h3>إدارة الأرانب</h3>
                            <p>تسجيل ومتابعة بيانات الأرانب في مزرعتك</p>
                            <button class="btn btn-primary" onclick="showSection('rabbits-section')">فتح</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="icon-box">
                                <i class="bi bi-heart"></i>
                            </div>
                            <h3>إدارة التزاوج</h3>
                            <p>متابعة عمليات التزاوج وجدولة المواعيد</p>
                            <button class="btn btn-primary" onclick="showDevelopmentMessage()">فتح</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="icon-box">
                                <i class="bi bi-clipboard2-pulse"></i>
                            </div>
                            <h3>السجلات الصحية</h3>
                            <p>متابعة الحالة الصحية والتطعيمات</p>
                            <button class="btn btn-primary" onclick="showDevelopmentMessage()">فتح</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="icon-box">
                                <i class="bi bi-basket"></i>
                            </div>
                            <h3>إدارة التغذية</h3>
                            <p>تسجيل استهلاك العلف ومتابعة المخزون</p>
                            <button class="btn btn-primary" onclick="showDevelopmentMessage()">فتح</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="icon-box">
                                <i class="bi bi-cash-coin"></i>
                            </div>
                            <h3>الإدارة المالية</h3>
                            <p>تسجيل المصروفات والإيرادات</p>
                            <button class="btn btn-primary" onclick="showDevelopmentMessage()">فتح</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <div class="icon-box">
                                <i class="bi bi-bar-chart"></i>
                            </div>
                            <h3>التقارير</h3>
                            <p>تقارير وإحصائيات مفصلة</p>
                            <button class="btn btn-primary" onclick="showDevelopmentMessage()">فتح</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- قسم إدارة الأرانب -->
        <div id="rabbits-section" class="section-container d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-database me-2"></i> إدارة الأرانب</h2>
                <div>
                    <button class="btn btn-success" onclick="showRabbitForm()">
                        <i class="bi bi-plus-circle"></i> إضافة أرنب جديد
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="showHomePage()">
                        <i class="bi bi-house"></i> العودة للرئيسية
                    </button>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-list-ul me-1"></i> قائمة الأرانب
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>الصورة</th>
                                    <th>الرقم</th>
                                    <th>الاسم</th>
                                    <th>النوع</th>
                                    <th>الجنس</th>
                                    <th>تاريخ الميلاد</th>
                                    <th>الحالة</th>
                                    <th>العمليات</th>
                                </tr>
                            </thead>
                            <tbody id="rabbits-table">
                                <tr>
                                    <td colspan="8" class="text-center">جاري تحميل البيانات...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- نموذج إضافة/تعديل أرنب -->
        <div id="rabbit-form-container" class="section-container d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 id="form-title"><i class="bi bi-pencil-square me-2"></i> إضافة أرنب جديد</h2>
                <button class="btn btn-secondary" onclick="showRabbitsSection()">
                    <i class="bi bi-x-circle"></i> إلغاء
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    <form id="rabbit-form">
                        <input type="hidden" id="rabbit-id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="rabbit-name" class="form-label">اسم الأرنب</label>
                                <input type="text" class="form-control" id="rabbit-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="rabbit-breed" class="form-label">النوع</label>
                                <input type="text" class="form-control" id="rabbit-breed" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="rabbit-gender" class="form-label">الجنس</label>
                                <select class="form-select" id="rabbit-gender" required>
                                    <option value="">اختر الجنس</option>
                                    <option value="ذكر">ذكر</option>
                                    <option value="أنثى">أنثى</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="rabbit-status" class="form-label">الحالة</label>
                                <select class="form-select" id="rabbit-status" required>
                                    <option value="">اختر الحالة</option>
                                    <option value="نشط">نشط</option>
                                    <option value="حامل">حامل</option>
                                    <option value="مريض">مريض</option>
                                    <option value="غير نشط">غير نشط</option>
                                    <option value="متوفي">متوفي</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="rabbit-birthdate" class="form-label">تاريخ الميلاد</label>
                                <input type="date" class="form-control" id="rabbit-birthdate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="rabbit-weight" class="form-label">الوزن (كجم)</label>
                                <input type="number" class="form-control" id="rabbit-weight" step="0.1" min="0">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="rabbit-image" class="form-label">صورة الأرنب</label>
                            <input type="file" class="form-control" id="rabbit-image" accept="image/*">
                            <div id="image-preview" class="mt-2 d-none">
                                <img id="preview-img" src="" alt="معاينة الصورة" style="max-width: 200px; max-height: 200px;">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="rabbit-notes" class="form-label">ملاحظات</label>
                            <textarea class="form-control" id="rabbit-notes" rows="3"></textarea>
                        </div>
                        
                        <div class="text-center">
                            <button type="button" class="btn btn-primary px-4" onclick="saveRabbit()">
                                <i class="bi bi-save"></i> حفظ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- حاوية رسائل التنبيه -->
    <div id="alert-container" class="alert-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // تهيئة قاعدة البيانات
        let db;
        const DB_NAME = 'RabbitFarmDB';
        const DB_VERSION = 1;

        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = function(event) {
            showAlert('حدث خطأ في فتح قاعدة البيانات', 'danger');
        };

        request.onupgradeneeded = function(event) {
            db = event.target.result;
            
            // إنشاء مخزن بيانات الأرانب
            if (!db.objectStoreNames.contains('rabbits')) {
                const rabbitsStore = db.createObjectStore('rabbits', { keyPath: 'id', autoIncrement: true });
                rabbitsStore.createIndex('name', 'name', { unique: false });
                rabbitsStore.createIndex('gender', 'gender', { unique: false });
                rabbitsStore.createIndex('status', 'status', { unique: false });
            }
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            console.log('تم فتح قاعدة البيانات بنجاح');
            
            // تحميل بيانات الأرانب إذا كنا في صفحة إدارة الأرانب
            if (!document.getElementById('rabbits-section').classList.contains('d-none')) {
                loadRabbits();
            }
        };

        // عرض الصفحة الرئيسية
        function showHomePage() {
            document.getElementById('home-page').classList.remove('d-none');
            document.getElementById('rabbits-section').classList.add('d-none');
            document.getElementById('rabbit-form-container').classList.add('d-none');
        }

        // عرض قسم معين
        function showSection(sectionId) {
            document.getElementById('home-page').classList.add('d-none');
            
            if (sectionId === 'rabbits-section') {
                document.getElementById('rabbits-section').classList.remove('d-none');
                document.getElementById('rabbit-form-container').classList.add('d-none');
                loadRabbits();
            }
        }

        // عرض قسم إدارة الأرانب
        function showRabbitsSection() {
            document.getElementById('home-page').classList.add('d-none');
            document.getElementById('rabbits-section').classList.remove('d-none');
            document.getElementById('rabbit-form-container').classList.add('d-none');
            loadRabbits();
        }

        // عرض نموذج إضافة أرنب
        function showRabbitForm(rabbitId = null) {
            document.getElementById('home-page').classList.add('d-none');
            document.getElementById('rabbits-section').classList.add('d-none');
            document.getElementById('rabbit-form-container').classList.remove('d-none');
            
            // إعادة تعيين النموذج
            document.getElementById('rabbit-form').reset();
            document.getElementById('image-preview').classList.add('d-none');
            
            if (rabbitId) {
                // تحرير أرنب موجود
                document.getElementById('form-title').innerHTML = '<i class="bi bi-pencil-square me-2"></i> تعديل بيانات الأرنب';
                loadRabbitData(rabbitId);
            } else {
                // إضافة أرنب جديد
                document.getElementById('form-title').innerHTML = '<i class="bi bi-plus-circle me-2"></i> إضافة أرنب جديد';
                document.getElementById('rabbit-id').value = '';
            }
        }

        // عرض رسالة "قيد التطوير"
        function showDevelopmentMessage() {
            showAlert('هذا القسم قيد التطوير حالياً وسيكون متاحاً قريباً', 'info');
        }

        // تحميل بيانات الأرانب
        function loadRabbits() {
            const tableBody = document.getElementById('rabbits-table');
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center">جاري تحميل البيانات...</td></tr>';
            
            getAllRecords('rabbits')
                .then(rabbits => {
                    if (rabbits.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center">لا توجد أرانب مسجلة</td></tr>';
                        return;
                    }
                    
                    tableBody.innerHTML = '';
                    rabbits.forEach(rabbit => {
                        const birthDate = rabbit.birthDate ? new Date(rabbit.birthDate).toLocaleDateString('ar-EG') : '-';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                ${rabbit.image 
                                    ? `<img src="${rabbit.image}" alt="صورة الأرنب" class="rabbit-image">` 
                                    : '<div class="text-center"><i class="bi bi-image text-muted" style="font-size: 2rem;"></i></div>'}
                            </td>
                            <td>${rabbit.id}</td>
                            <td>${rabbit.name || '-'}</td>
                            <td>${rabbit.breed || '-'}</td>
                            <td>${rabbit.gender || '-'}</td>
                            <td>${birthDate}</td>
                            <td><span class="badge ${getStatusBadgeClass(rabbit.status)}">${rabbit.status || '-'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary mb-1" onclick="showRabbitForm(${rabbit.id})">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-danger mb-1" onclick="deleteRabbit(${rabbit.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">خطأ: ${error.message}</td></tr>`;
                });
        }

        // تحميل بيانات أرنب للتعديل
        function loadRabbitData(id) {
            getRecord('rabbits', id)
                .then(rabbit => {
                    if (!rabbit) {
                        showAlert('الأرنب غير موجود', 'danger');
                        showRabbitsSection();
                        return;
                    }
                    
                    document.getElementById('rabbit-id').value = rabbit.id;
                    document.getElementById('rabbit-name').value = rabbit.name || '';
                    document.getElementById('rabbit-breed').value = rabbit.breed || '';
                    document.getElementById('rabbit-gender').value = rabbit.gender || '';
                    document.getElementById('rabbit-status').value = rabbit.status || '';
                    document.getElementById('rabbit-weight').value = rabbit.weight || '';
                    document.getElementById('rabbit-notes').value = rabbit.notes || '';
                    
                    if (rabbit.birthDate) {
                        const birthDate = new Date(rabbit.birthDate);
                        const formattedDate = birthDate.toISOString().split('T')[0];
                        document.getElementById('rabbit-birthdate').value = formattedDate;
                    }
                    
                    if (rabbit.image) {
                        document.getElementById('preview-img').src = rabbit.image;
                        document.getElementById('image-preview').classList.remove('d-none');
                    }
                })
                .catch(error => {
                    showAlert('خطأ في تحميل بيانات الأرنب: ' + error.message, 'danger');
                });
        }

        // حفظ بيانات الأرنب
        function saveRabbit() {
            const form = document.getElementById('rabbit-form');
            
            // التحقق من صحة النموذج
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const id = document.getElementById('rabbit-id').value;
            const name = document.getElementById('rabbit-name').value;
            const breed = document.getElementById('rabbit-breed').value;
            const gender = document.getElementById('rabbit-gender').value;
            const status = document.getElementById('rabbit-status').value;
            const birthDate = document.getElementById('rabbit-birthdate').value;
            const weight = document.getElementById('rabbit-weight').value;
            const notes = document.getElementById('rabbit-notes').value;
            
            // معالجة الصورة
            const imageFile = document.getElementById('rabbit-image').files[0];
            
            // إذا كانت هناك صورة جديدة، قم بتحويلها إلى Base64
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    saveRabbitData(id, name, breed, gender, status, birthDate, weight, notes, imageData);
                };
                reader.readAsDataURL(imageFile);
            } else {
                // إذا لم تكن هناك صورة جديدة، تحقق مما إذا كان هناك صورة موجودة للأرنب
                if (id) {
                    getRecord('rabbits', parseInt(id))
                        .then(rabbit => {
                            const existingImage = rabbit ? rabbit.image : null;
                            saveRabbitData(id, name, breed, gender, status, birthDate, weight, notes, existingImage);
                        })
                        .catch(error => {
                            showAlert('خطأ في استرداد بيانات الأرنب: ' + error.message, 'danger');
                        });
                } else {
                    saveRabbitData(id, name, breed, gender, status, birthDate, weight, notes, null);
                }
            }
        }

        // حفظ بيانات الأرنب في قاعدة البيانات
        function saveRabbitData(id, name, breed, gender, status, birthDate, weight, notes, image) {
            const rabbit = {
                name,
                breed,
                gender,
                status,
                birthDate: birthDate ? new Date(birthDate) : null,
                weight: weight ? parseFloat(weight) : null,
                notes,
                image
            };
            
            if (id) {
                // تحديث أرنب موجود
                updateRecord('rabbits', parseInt(id), rabbit)
                    .then(() => {
                        showAlert('تم تحديث بيانات الأرنب بنجاح', 'success');
                        showRabbitsSection();
                    })
                    .catch(error => {
                        showAlert('خطأ في تحديث بيانات الأرنب: ' + error.message, 'danger');
                    });
            } else {
                // إضافة أرنب جديد
                addRecord('rabbits', rabbit)
                    .then(() => {
                        showAlert('تمت إضافة الأرنب بنجاح', 'success');
                        showRabbitsSection();
                    })
                    .catch(error => {
                        showAlert('خطأ في إضافة الأرنب: ' + error.message, 'danger');
                    });
            }
        }

        // حذف أرنب
        function deleteRabbit(id) {
            if (confirm('هل أنت متأكد من حذف هذا الأرنب؟')) {
                deleteRecord('rabbits', id)
                    .then(() => {
                        showAlert('تم حذف الأرنب بنجاح', 'success');
                        loadRabbits();
                    })
                    .catch(error => {
                        showAlert('خطأ في حذف الأرنب: ' + error.message, 'danger');
                    });
            }
        }

        // الحصول على فئة شارة الحالة
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'نشط': return 'bg-success';
                case 'حامل': return 'bg-info';
                case 'مريض': return 'bg-warning';
                case 'غير نشط': return 'bg-secondary';
                case 'متوفي': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // إضافة سجل جديد
        function addRecord(storeName, record) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('قاعدة البيانات غير متاحة'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(record);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // الحصول على سجل بواسطة المعرف
        function getRecord(storeName, id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('قاعدة البيانات غير متاحة'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // الحصول على جميع السجلات
        function getAllRecords(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('قاعدة البيانات غير متاحة'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // تحديث سجل
        function updateRecord(storeName, id, record) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('قاعدة البيانات غير متاحة'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const getRequest = store.get(id);
                
                getRequest.onsuccess = () => {
                    const existingRecord = getRequest.result;
                    if (!existingRecord) {
                        reject(new Error('السجل غير موجود'));
                        return;
                    }
                    
                    // دمج السجل الموجود مع البيانات الجديدة
                    const updatedRecord = { ...existingRecord, ...record };
                    
                    // الاحتفاظ بالمعرف
                    updatedRecord.id = id;
                    
                    // تحديث السجل
                    const updateRequest = store.put(updatedRecord);
                    
                    updateRequest.onsuccess = () => resolve();
                    updateRequest.onerror = () => reject(updateRequest.error);
                };
                
                getRequest.onerror = () => reject(getRequest.error);
            });
        }

        // حذف سجل
        function deleteRecord(storeName, id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('قاعدة البيانات غير متاحة'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // عرض رسالة تنبيه
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // إخفاء التنبيه تلقائيًا بعد 5 ثوانٍ
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000);
        }

        // معاينة الصورة قبل الرفع
        document.getElementById('rabbit-image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview-img').src = e.target.result;
                    document.getElementById('image-preview').classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('image-preview').classList.add('d-none');
            }
        });
    </script>
</body>
</html>
